KISSY.add(function(b){var d=b.DOM,a=b.Event;function c(f){var e=this;f=b.merge(c.config,f);c.superclass.constructor.call(e,f);e.events=["load","pushPath","popPath","pushView","popView","searchTree","searchView","changeSelect"];e._init()}c.config={url:null,idKey:null,param:{},autoLoad:true,adapterForNode:{id:"id",value:"value",children:"children",parent:"parent",isleaf:"isleaf"},adapterForData:{success:"success",nodes:"nodes",message:"message"},dataErrorFunc:function(e){alert(e)}};b.extend(c,b.Base);b.augment(c,{isTreeReady:function(i,h){var e=this,f=e.get("adapterForNode"),g,j=true;if(i){if(i[f.isleaf]){return true}else{g=i[f.children]}}else{g=e.getTreeData()}if(g.length===0){j=false}if(!j){var k=i?i[f.id]:null;e.load(k,null,h)}return j},load:function(g,e,h,k){var l=this,j=l.get("adapterForData"),i=l.get("adapterForNode"),m=l.get("idKey")||i.id,k=k||false;e=e||l.get("url");g=g||l.get("param");if(b.isNumber(g)||b.isString(g)){var f={};f[m]=g;g=f}if(!e){throw"please assign the URL of Data for Tree!"}b.io({url:e,dataType:"json",data:g,type:"post",success:function(n){if(n[j.success]===true||n[j.success]==="true"){l.fire("load",{data:n[j.nodes],id:k?null:g[m]||null,param:g});if(h){h()}}else{l._dataError(n[messageStr])}},error:function(){l._dataError("\u8bf7\u6c42\u5f02\u5e38\uff01")}})},traverseTreeById:function(l){var e=this,f=e.get("adapterForNode"),k=e.getTreeData(),j=[],g=[],i=[],h;h=function(n,m){m=m||0;for(var o=0;o<n.length;o++){if(n[o][f.id]===l||(!n[o][f.isleaf]&&h(n[o][f.children],m+1))){j[m]=n[o][f.id];g[m]=n[o][f.value];i[m]=n[o];return true}}return false};if(l){h(k)}return{path:j,valuePath:g,pathNode:i,node:i[i.length-1]||null}},traverseTreeByText:function(l){var k=this,e=k.get("adapterForNode"),m=k.getTreeData(),o=[],i=[],j=[],n=[],f=[],g=[],h;h=function(s,q){q=q||0;for(var t=0;t<s.length;t++){var p=o.length-q-1;for(var r=0;r<p;r++){o.pop();j.pop();i.pop()}o[q]=s[t][e.id];j[q]=s[t][e.value];i[q]=s[t];if(s[t][e.value].indexOf(l)>-1){n.push(b.clone(o));g.push(b.clone(j));f.push(k._viewDataFilter(i))}if(!s[t][e.isleaf]){h(s[t][e.children],q+1)}}};if(l){h(m)}return{pathList:n,pathNodeList:f,valuePathList:g}},getNodeById:function(f){var e=this;return e.traverseTreeById(f).node},getNodeByPath:function(j){j=j||[];var e=this,f=e.get("adapterForNode"),i=e.getTreeData(),h=null,g=i;b.each(j,function(k){b.each(g,function(l){if(l[f.id]===k){h=l;return false}});g=h[f.children]});return h},getPathById:function(f){var e=this;return e.traverseTreeById(f).path},getParentById:function(i){var e=this,f=e.get("adapterForNode"),g=e.getNodeById(i),h=g[f.parent];return e.getNodeById(parent)},getChildrenById:function(g){var e=this,f=e.get("adapterForNode");return e.getNodeById(g)[f.children]||[]},getChildrenByPath:function(g){g=g||[];var e=this,f=e.get("adapterForNode");if(g.length===0){return e.getTreeData()}else{return e.getNodeByPath(g)[f.children]||[]}},getTreeData:function(){var e=this;return e.get("treeData")},setTreeData:function(e,f){_self.fire("load",{data:e,id:f})},searchTree:function(g){var f=this,e=f.traverseTreeByText(g);f.fire("searchTree",{text:g,pathList:e.pathList,valuePathList:e.valuePathList,result:e});return e},getViewManager:function(){return this.get("viewManager")},getViewsByPath:function(o){o=o||[];var n=this,l=n.getViewManager(),m=l.viewPath.length,f=n.get("adapterForNode"),g=0,e=n.getNodeByPath(o);if(!n.isTreeReady(e,function(){n.getViewsByPath(o)})){return false}if(o.length===0){n._setBaseView()}b.each(o,function(k,j){if(k!==l.viewPath[j]){g=j;return false}});for(var i=0;i<(m-g);i++){n._popViewPath()}for(var h=g;h<o.length;h++){n._pushViewPath(o[h])}return l},getViewsById:function(g){var e=this,f=e.getPathById(g);return e.getViewsByPath(f)},getViewIndex:function(f){var e=this,h=e.getViewManager(),g=null;b.each(h.views,function(j,k){if(j===f){g=k;return false}});return g},searchView:function(k,i){var e=this,g=e.get("adapterForNode"),h=e.getViewManager(),f=h.views[i],j;k=k||"";j=b.filter(f.list,function(l){return l[g.value].indexOf(k)>-1});e.fire("searchView",{data:j,index:i,text:k});return j},destroy:function(){var e=this;e.detach();e=null},_init:function(){var e=this;e.set("treeData",[]);e._initViewManage();e._initEvent();if(e.get("autoLoad")){e.load()}},_initEvent:function(){var e=this;e.on("pushPath",function(f){e._pushView(f.id,f.path)});e.on("popPath",function(f){e._popView()});e.on("load",function(f){e._fillInTreeData(f.data,f.id)})},_fillInTreeData:function(i,j){var e=this,f=e.get("adapterForNode"),g=e.getTreeData(),h;if(j){h=e.getNodeById(j);if(h){g=h[f.children]}}g.length=0;b.each(i,function(k){g.push(k)})},_dataError:function(e){if(e){_self.get("dataErrorFunc")(e)}},_initViewManage:function(){var e=this,f={viewPath:[],views:[]};e.set("viewManager",f)},_initView:function(g){g=g||[];var e=this,f={};f.list=e._getDataOfView(g);f.selectedId=null;return f},_setBaseView:function(){var e=this,g=e.getViewManager(),f;if(g.views.length===0){f=e._initView();g.views.push(f);e.fire("pushView",{view:f})}},_getDataOfView:function(i){i=i||[];var e=this,f=e.get("adapterForNode"),h=e.getChildrenByPath(i),g=e._viewDataFilter(h);return g},_viewDataFilter:function(h){var e=this,f=e.get("adapterForNode"),g=[];b.each(h,function(j){var i=b.clone(j,function(m,l){if(l===f.children){return false}});g.push(i)});return g},_pushViewPath:function(g){var e=this,f=e.getViewManager();f.viewPath.push(g);e.fire("pushPath",{id:g,path:f.viewPath});return f.viewPath},_popViewPath:function(){var e=this,f=e.getViewManager(),g;if(f.viewPath.length===0){return}g=f.viewPath.pop();e.fire("popPath",{id:g,path:f.viewPath});return f.viewPath},_pushView:function(k,i){var e=this,h=e.getViewManager(),j=e._initView(i),g,f;e._setBaseView();f=h.views[h.views.length-1];e._changeViewSelect(f,k);h.views.push(j);e.fire("pushView",{view:j});return j},_popView:function(){var e=this,g=e.getViewManager(),h,f;h=g.views.pop();e.fire("popView",{view:h});f=g.views[g.views.length-1];e._changeViewSelect(f,null);return h},_changeViewSelect:function(f,g){var e=this;f.selectedId=g;e.fire("changeSelect",{view:f,id:g})}});b.namespace("LP");b.LP.TreeStore=c},{requires:[]});
