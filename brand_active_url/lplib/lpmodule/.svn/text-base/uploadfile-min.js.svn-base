KISSY.add(function(c){var d=c.DOM,b=c.Event;function a(f){var e=this;f=c.merge(a.config,f);if(!f.renderTo||!d.get("#"+f.renderTo)){throw"please assign the id of render Dom!"}a.superclass.constructor.call(e,f);e.events=["addResult","delResult","updateResult","updateResultCon"];e._init()}a.config={renderTo:null,url:null,extendName:[],resultId:null,max:null,isImage:false};c.extend(a,c.Base);c.augment(a,{addResult:function(k,l){var h=this,g=h.getResult(),f=h.get("max"),e=h._isNewResult(k),j,i={name:k,path:l};if(e===true){if(f&&f<g.length+1){j=g.pop();h.fire("delResult",{del:j,result:g})}g.push(i);h.fire("addResult",{add:i,result:g})}else{g[e].path=l}h.fire("updateResult",{result:g});return g},delResult:function(i){var f=this,e=f.getResult(),h=null,g=null;c.each(e,function(k,j){if(k.name===i){h=j;return false}});if(h!==null){g=e.splice(h,1);f.fire("delResult",{del:g[0],result:e})}f.fire("updateResult",{result:e});return g},initShow:function(f){var e=this;e.set("result",f);c.each(f,function(g){e._addShow(g.name,g.path)})},getUpload:function(){return this.get("upload")},getResult:function(){return this.get("result")},getPathListFromResult:function(){var f=this,e=f.getResult(),g=[];c.each(e,function(h){g.push(h.path)});return g},_init:function(){var g=this,f=g.get("resultId"),h=f?c.one("#"+f):null;g._initUpload();g._initDom();g._initEvent();g.set("result",[]);if(h){g.set("resultCon",h);if(!!h.val()){var e=c.JSON.parse(h.val());if(c.isPlainObject(e)){g.initShow(e.result)}}}},_initUpload:function(){var e=this,f=new c.LP.Upload({renderTo:"#"+e.get("renderTo"),extendName:e.get("extendName"),url:e.get("url")});e.set("upload",f)},_initEvent:function(){var e=this,f=e.getUpload();f.on("uploadCompeleted",function(g){e._uploadCallback(c.JSON.parse(g.msg))});e.on("addResult",function(g){e._addShow(g.add.name,g.add.path)});e.on("delResult",function(g){e._delShow(g.del.name)});e.on("updateResult",function(){e._updateResult()})},_uploadCallback:function(f){var e=this;if(f){if(f.success){e.addResult(f.fileName,f.filePath)}else{new c.LP.Message.Base({title:"\u4e0a\u4f20\u9519\u8bef",message:f.message||"\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u518d\u8bd5\uff01",icons:"error",button:[{text:"\u786e\u5b9a"}]})}}},_isNewResult:function(h){var g=this,f=g.getResult(),e=true;c.each(f,function(k,j){if(k.name===h){e=j;return false}});return e},_initDom:function(){var f=this,g='<span class="fileshow-area"></span>',e=d.create(g);d.insertAfter(e,"#"+f.get("renderTo"));f.set("showArea",c.one(e));f.set("showManage",{})},_addShow:function(e,m){var i=this,j=i.get("showArea"),l=i.get("isImage")?'<img src="'+m+'" title="'+e+'"/>':e,f=['<span class="fileshow" data-name="',e,'" data-path="',m,'">',l,"<s>X</s></span>"].join(""),h=new c.Node(f),k=c.one("s",h),g=i.get("showManage");j.append(h);k.on("click",function(){var o=c.one(this).parent("span").attr("data-name");i.delResult(o)});g[e]={path:m,showEl:h,delBtn:k}},_delShow:function(g){var e=this,f=e.get("showManage");f[g].delBtn.detach();f[g].showEl.remove();delete f[g]},_updateResult:function(){var f=this,g=f.get("resultCon")||null,e=f.getResult();if(g){if(e.length===0){g.val("")}else{g.val(c.JSON.stringify({result:e}))}f.fire("updateResultCon",{value:g.val()})}}});c.namespace("LP");c.LP.UploadFile=a},{requires:["lpmodule/upload","1.0/message","lpmodule/css/module.css"]});
