KISSY.add(function(c){var d=c.DOM,b=c.Event;Node=c.Node,CLS_GRID_CELL="grid-body-cell",CLS_GRID_ROW_SELECTED="grid-row-selected",CLS_GRID_CELL_INNER="grid-body-cell-inner",DATA_ELEMENT="row-element",CLS_CHECKBOX="grid-checkbox",CLS_GRID_GROUP_ROW="grid-group-row",CLS_GRID_GROUP_ROW_FIRST="grid-group-row-first",CLS_GRID_GROUP_CELL="grid-group-cell",CLS_GRID_GROUP_TITLE="grid-group-title",CLS_GRID_GROUP_TEXT="grid-group-text",DATA_GROUP_ROW="groupRowData",CLS_GROUP_ROW_SELECTED="grid-group-selected";function a(f){var e=this;f=f||{};f=c.merge(a.config,f);a.superclass.constructor.call(e,f);e.events=["grouprowclick","grouprowcreated","grouprowselected","grouprowunselected","grouprowselectchanged"];e._initGroupGrid()}a.config={groupColumns:[],groupIndex:null};c.extend(a,c.LP.Grid);c.augment(a,{_initGroupGrid:function(){var e=this,f=e.get("groupColumns");if(c.isEmptyObject(f)){return}e._initGroupManager();e._initGroupEvent()},_initGroupManager:function(){var e=this,g=e.get("groupColumns"),h=e.get("groupIndex"),f={columns:{},rowTemp:null,index:h||g[0].dataIndex};c.each(g,function(j){var i={};i.value="";i.title=j.title;i.renderer=j.renderer||null;f.columns[j.dataIndex]=i});e.set("groupManager",f)},_initGroupEvent:function(){var e=this;e.on("grouprowcreated",function(f){b.on(f.row,"click",function(g){e._groupRowClick(g.target)})});e.on("grouprowselectchanged",function(f){e._groupRowSelect(f.row,f.data,f.selected)});e.on("beginshow",function(){e._initGroupManager()})},_createRow:function(j,m){var n=this,l=n.get("tbody"),o,g,h,f;var k=n.get("groupManager"),e=null;if(k){if(k.columns[k.index].value!==j[k.index]){k.columns[k.index].value=j[k.index];e=n._creatGroupRow(j,m);k.rowTemp=e}}o=n._getRowTemplate(m,j);g=new Node(o).appendTo(l);h=g.getDOMNode();f=h.lastChild;if(k&&k.rowTemp){var i=d.data(k.rowTemp,DATA_GROUP_ROW);i.childrenRow.push(h)}d.data(h,DATA_ELEMENT,j);d.addClass(f,"lp-last");n.fire("rowcreated",{data:j,row:h});return g},_creatGroupRow:function(i,g){var f=this,e=f.get("tbody"),j=f._getGroupRowTemplate(i),h=new Node(j).appendTo(e);h.data(DATA_GROUP_ROW,{childrenRow:[]});if(g===0){h.addClass(CLS_GRID_GROUP_ROW_FIRST)}f.fire("grouprowcreated",{row:h[0]});return h[0]},_getGroupRowTemplate:function(g){var e=this,f=e.get("groupManager"),h=[];groupRowTempArray=[],cellSpan=e.get("columns").length,checkable=e.get("checkable"),checkCell="";if(checkable){checkCell=e._getCheckedCellTemplate("grid-row-checked-column",CLS_GRID_CELL)}c.each(f.columns,function(j,i){var k=j.renderer?j.renderer(g[i],g):g[i];h.push(['<span class="',CLS_GRID_GROUP_TITLE,'">',j.title,':</span><span class="',CLS_GRID_GROUP_TEXT,'">',k,"</span>"].join(""))});groupRowTempArray=['<tr class="',CLS_GRID_GROUP_ROW,'">',checkCell,'<td class="',CLS_GRID_GROUP_CELL,'" colspan="',cellSpan,'"><div class="',CLS_GRID_CELL_INNER,'">',h.join(""),"</div></td></tr>"];return groupRowTempArray.join("")},_isGroupRowSelected:function(e){return c.one(e).hasClass(CLS_GROUP_ROW_SELECTED)},_setGroupRowSelected:function(i,g){var f=this,h=d.get("."+CLS_CHECKBOX,i),e=d.hasClass(i,CLS_GROUP_ROW_SELECTED);if(e===g){return}if(h){if(d.attr(h,"disabled")){return}h.checked=g}if(g){d.addClass(i,CLS_GROUP_ROW_SELECTED);f._onGroupRowSelectChanged(i,g)}else{d.removeClass(i,CLS_GROUP_ROW_SELECTED);f._setHeaderChecked(false);f._onGroupRowSelectChanged(i,g)}},_onGroupRowSelectChanged:function(h,f){var e=this,g=d.data(h,DATA_GROUP_ROW);if(f){e.fire("grouprowselected",{data:g,row:h})}else{e.fire("grouprowunselected",{data:g,row:h})}e.fire("grouprowselectchanged",{data:g,row:h,selected:f})},_groupRowClick:function(h){var e=this,f=e.get("checkable"),i=e._lookupByClass(h,CLS_GRID_GROUP_ROW),g;if(i){g=d.data(i,DATA_GROUP_ROW);e.fire("grouprowclick",{data:g,row:i});if(f){if(!e._isGroupRowSelected(i)){e._setGroupRowSelected(i,true)}else{e._setGroupRowSelected(i,false)}}else{var j=c.one("."+CLS_GROUP_ROW_SELECTED,i.parentNode);if(j){j.removeClass(CLS_GROUP_ROW_SELECTED);e._onGroupRowSelectChanged(j[0],false)}d.addClass(i,CLS_GROUP_ROW_SELECTED);e._onGroupRowSelectChanged(i,true)}}},_groupRowSelect:function(i,h,g){var e=this,f=e.get("checkable");if(f){c.each(h.childrenRow,function(j){e._setRowSelected(j,g)})}}});c.namespace("LP");c.LP.GroupGrid=a},{requires:["1.0/grid"]});
