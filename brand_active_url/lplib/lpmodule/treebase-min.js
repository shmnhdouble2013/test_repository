KISSY.add(function(b){var c=b.DOM,a=b.Event;function d(f){var e=this;f=b.merge(d.config,f);if(!f.renderTo||!c.get("#"+f.renderTo)){throw"please assign the id of render Dom!"}d.superclass.constructor.call(e,f);e.events=["load","searchTree","resultPush","resultPop","resultUpdate","beforeDestroy","pushList","popList","itemChangeSelect","changeSelectByClick","changeSelectByStore","pathUpdate"];e.__init()}d.config={renderTo:null,resultId:null,resultType:"result",store:null,url:null,idKey:null,param:{},treeStoreConfig:{}};b.extend(d,b.Base);b.augment(d,{treeStoreLoad:function(g){var e=this,f=e.getTreeStore();f.load(g)},getTreeStore:function(){return this.get("treeStore")},searchTree:function(g){var e=this,f=e.getTreeStore();return f.searchTree(g)},getResult:function(){return this.get("result")},getIdFromResult:function(){var f=this,e=f.getResult();if(e.length===0){return null}return e[e.length-1].id},getValueFromResult:function(){var f=this,e=f.getResult();if(e.length===0){return null}return e[e.length-1].value},getPathFromResult:function(){var f=this,e=f.getResult(),g=[];b.each(e,function(h){g.push(h.id)});return g},getValuePathFromResult:function(){var f=this,e=f.getResult(),g=[];b.each(e,function(h){g.push(h.value)});return g},getValueStrFromResult:function(){var f=this,e=f.getResult(),g=[],i=" > ",h;b.each(e,function(k){var j=k.value;if(!k.isleaf){j+=i}g.push(j)});return g.join("")},initData:function(){var f=this,i=f.get("resultInput"),g=f.get("resultType").split(" "),e=null,h=null;if(i){e=b.JSON.parse(i.val());if(e!==null){if(b.inArray("result",g)){h=e.result[e.result.length-1].id}else{if(b.inArray("id",g)){h=e.id}else{if(b.inArray("path",g)){h=e.path[e.path.length-1]}}}}}f.updateListsById(h)},isBlankResult:function(){var f=this,e=f.get("result"),g=false;if(e.length===0){g=true}return g},isLeafResult:function(){var f=this,e=f.get("result"),g=false;if(!f.isBlankResult()){g=e[e.length-1].isleaf}return g},getListManager:function(){return this.get("listManager")},updateListsByPath:function(g){var e=this,f=e.getTreeStore();f.getViewsByPath(g)},updateListsById:function(g){var e=this,f=e.getTreeStore();f.getViewsById(g)},destroy:function(){var e=this,h=e.get("treeStore"),f=e.get("container"),g=e.getListManager();e.fire("beforeDestroy");b.each(g.lists,function(i){e._destroyList(i)});h.destroy();f[0].innerHTML="";e.detach();e=null},__init:function(){var f=this,g=b.one("#"+f.get("renderTo")),h=b.one("#"+f.get("resultId")),e=[];f._initTreeStore();f.set("container",g);if(h){f.set("resultInput",h)}f.set("result",e);f.__initEvent()},__initEvent:function(){var e=this,f=e.getTreeStore();f.on("searchTree",function(g){e.fire("searchTree",{text:g.text,pathList:g.pathList,valuePathList:g.valuePathList,result:g.result})});f.on("load",function(g){e.fire("load",{data:g.data,id:g.id,param:g.param})})},_getTreeStoreConfig:function(){var e=this,f=e.get("treeStoreConfig");b.mix(f,{url:e.get("url"),idKey:e.get("idKey"),param:e.get("param"),autoLoad:false});return f},_initTreeStore:function(){var e=this,f=e.get("store"),g;if(!f){g=e._getTreeStoreConfig();f=new b.LP.TreeStore(g)}e.set("treeStore",f)},_pushResult:function(h){var g=this,f=g.getResult(),i={},e;i.id=h.id;i.value=h.value;i.isleaf=h.isleaf;f.push(i);g.fire("resultPush",{result:f,resultObj:i});g.fire("resultUpdate",{result:f})},_popResult:function(){var f=this,e=f.getResult(),g=e.pop();f.fire("resultPop",{result:e,resultObj:g});f.fire("resultUpdate",{result:e})},_initListTree:function(){var e=this;e._initListManager();e._initListTreeEvent();e.treeStoreLoad()},_initListManager:function(){var e=this,f={listPath:[],lists:[]};e.set("listManager",f)},_pushList:function(h){var e=this,g=e.getListManager(),f=e._initList(h,g.lists.length);g.lists.push(f);e.fire("pushList",{list:f});return f},_popList:function(){var e=this,g=e.getListManager(),f=g.lists.pop();e._destroyList(f);e.fire("popList",{list:f});return f},_itemChangeSelect:function(g){var e=this,f=g.data("nodeData")||{};e.fire("itemChangeSelect",{item:g,data:f,index:f.index})},_getSelectedPath:function(f){var e=this,g=e.getListManager(),h=[];if(f===null||f===undefined){f=g.lists.length-1}b.each(g.lists,function(k,j){if(j>f){return false}if(k.selectedId){h.push(k.selectedId)}});g.listPath=h;e.fire("pathUpdate",{path:h})},_searchList:function(h,f){var e=this,g=e.getTreeStore();g.searchView(h,f)},_updataListForSearch:function(j,g,k){var e=this,h=e.getListManager(),i=h.lists[g],f=i.selectedId;e._destroyListItems(i);e._initListItems(i,j,g,f,k)},_updateResult:function(){var f=this,h=f.get("resultInput"),g=f.get("resultType").split(" "),e={};_result=null;if(h){if(b.inArray("result",g)){_result=f.getResult();if(_result&&_result.length>0){e.result=_result}}if(b.inArray("id",g)){_result=f.getIdFromResult();if(_result!==null&&_result!==""){e.id=_result}}if(b.inArray("value",g)){_result=f.getValueFromResult();if(_result!==null&&_result!==""){e.value=_result}}if(b.inArray("path",g)){_result=f.getPathFromResult();if(_result&&_result.length>0){e.path=_result}}if(b.inArray("valuePath",g)){_result=f.getValuePathFromResult();if(_result&&_result.length>0){e.valuePath=_result}}if(b.inArray("valueStr",g)){_result=f.getValueStrFromResult();if(_result!==null&&_result!==""){e.valueStr=_result}}h.val(b.isEmptyObject(e)?"":b.JSON.stringify(e))}},_initListTreeEvent:function(){var e=this,f=e.getTreeStore();e.on("load",function(){f.getViewsByPath();if(!e.get("isInit")){e.initData();e.set("isInit",true)}});f.on("popView",function(){e._popList()});f.on("pushView",function(g){e._pushList(g.view.list)});f.on("changeSelect",function(g){e._changeSelectByStore(g.id)});f.on("searchView",function(g){e._updataListForSearch(g.data,g.index,g.text)});e.on("itemChangeSelect",function(g){e._changeSelectByClick(g.item,g.index)});e.on("changeSelectByClick",function(g){e._getSelectedPath(g.index)});e.on("pathUpdate",function(g){e.updateListsByPath(g.path)});e.on("changeSelectByStore",function(h){var g=this;if(h.item){g._pushResult(h.item.data("nodeData"))}else{g._popResult()}});e.on("resultUpdate",function(g){e._updateResult()})},_changeSelectByClick:function(h,f){var e=this,g=e.getListManager(),i=g.lists[f];if(!e._isItemSelect(h)){e._removeAllSelectByItem(h);e._addItemSelect(h)}e._setListSelected(i,h,h.data("nodeData").id);e.fire("changeSelectByClick",{list:i,item:h,index:f})},_changeSelectByStore:function(k){var e=this,h=e.getListManager(),j=h.lists[h.lists.length-1],g=e._getItems(j),i=j.selectedItem,f=j.selectedId;if(!(k&&f&&f===k)){if(i){e._removeItemSelect(i)}if(k){b.each(g,function(l){l=b.one(l);if(l.data("nodeData").id===k){i=l;f=k;return false}});e._addItemSelect(i)}else{i=null;f=null}e._setListSelected(j,i,f)}e.fire("changeSelectByStore",{list:j,item:i});return i},_setListSelected:function(f,e,g){f.selectedItem=e;f.selectedId=g},_isItemSelect:function(e){},_addItemSelect:function(e){},_removeItemSelect:function(e){},_removeAllSelectByItem:function(e){},_removeAllSelectByList:function(e){},_initList:function(i,g){var e=this,h={},f;if(i.length===0){return{}}f=e._initListDom(h,g);e._initListData(h,f,g);e._initListItems(h,i,g);e._initListEvent(h);return h},_initListData:function(h,f,g){var e=this;h.dom=f;h.index=g;e._setListSelected(h,null,null)},_initListDom:function(f,e){},_initListEvent:function(e){},_initListItems:function(i,h,g,k,j){var e=this,f=e.getTreeStore().get("adapterForNode");b.each(h,function(n){var m,l={id:n[f.id],parent:n[f.parent],value:n[f.value],isleaf:n[f.isleaf]};m=e._initListItemsDom(i,l,g,k,j);if(k&&k===l.id){e._addItemSelect(m);e._setListSelected(i,m,k)}e._initListItemsEvent(m);e._initListItemsData(m,l,g)})},_initListItemsData:function(g,f,e){f.index=e;g.data("nodeData",f)},_initListItemsDom:function(g,f,e,i,h){},_initListItemsEvent:function(e){},_getItems:function(e){},_destroyList:function(g){var e=this,f;if(!b.isEmptyObject(g)){e._destroyListItems(g);g.dom.detach().remove();g={}}},_destroyListItems:function(g){var e=this,f=e._getItems(g);f.detach().remove()}});b.namespace("LP");b.LP.TreeBase=d},{requires:["lpmodule/treestore"]});
