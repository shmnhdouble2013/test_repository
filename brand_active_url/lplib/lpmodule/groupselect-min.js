KISSY.add(function(d){var p=d.DOM,r=d.Event;var k="J_AddSelect",f="J_DelSelect",c="J_SearchInput",o="J_SearchBtn",i="J_SearchTip",g="source-select",a="target-select",b="select-tip",j="grid",h="group-select ks-clear",q='<div class="select-tip"></div>',m=['<div class="select-search">','<input type="text" class="',c,'"/>','<a class="small-white-button" href="javascript:void(0);">','<button type="button" class="',o,'">\u641c \u7d22</button>',"</a>",'<p class="',i,'"></p>',"</div>"].join(""),l=['<div class="add-del-select">','<a class="small-white-button" href="javascript:void(0);">','<button type="button" class="',k,'">\u6dfb\u52a0 &gt;&gt;</button>',"</a>",'<a class="small-white-button" href="javascript:void(0);">','<button type="button" class="',f,'">&lt;&lt; \u79fb\u9664</button>',"</a>","</div>"].join("");function n(t){var s=this;t=d.merge(n.config,t);if(!t.container){throw"please assign the dom of select container!"}n.superclass.constructor.call(s,t);s.events=["load"];s._init()}n.config={container:null,url:null,param:{},data:[],columns:[],width:250,height:200,checkable:false,isSearch:true,searchTip:"",searchKey:"key",searchValue:"",tip:""};d.extend(n,d.Base);d.augment(n,{load:function(u){var s=this,t=s.getStore();if(s.get("url")){u=u||s.get("param");t.load(u);s.set("param",u)}else{s.setData()}},setData:function(u){var s=this,t=s.getStore();u=u||s.get("data");t.setResult(u)},getGrid:function(){return this.get("grid")},getStore:function(){return this.get("store")},getData:function(){var s=this,t=s.getStore();return t.getResult()},getSelectedData:function(){var s=this,t=s.getGrid();return t.getSelection()},destroy:function(){var t=this,x=t.getStore(),y=t.getGrid(),v=t.get("isSearch"),u=t.get("container");y.destroy();x.destroy();if(v){var s=t.get("searchTip"),w=t.get("searchInput"),z=t.get("searchBtn");s.detach();w.detach();z.detach()}u.innerHTML="";t.detach();t=null},set:function(s,t){e.superclass.set.call(this,s,t,{silent:1})},_init:function(){var s=this;s._initDom();s._initGrid();s._initEvent()},_initDom:function(){var B=this,A=B.get("isSearch"),t=B.get("container"),x=d.guid(j),u="";u+=A?m:q;u+=['<div id="',x,'"></div>'].join("");t.innerHTML=u;if(A){var w=B.get("searchTip"),s=B.get("searchValue"),y=d.one("."+i,t),D=d.one("."+c,t),z=d.one("."+o,t);y.text(w);if(!!s){D.val(s);w.hide()}B.set("searchTip",y);B.set("searchInput",D);B.set("searchBtn",z)}else{var C=B.get("tip"),v=d.one("."+b,t);v.text(C)}B.set("gridId",x)},_initStore:function(){var s=this,t=s.get("isSearch"),v=s.get("url"),x,w=s.get("data"),u;if(v){if(t){x={};x[s.get("searchKey")]=s.get("searchValue")}else{x=s.get("param")}u=new d.LP.Store({url:v,param:x,autoLoad:true})}else{u=new d.LP.Store({autoLoad:false})}s.set("store",u)},_initGrid:function(){var t=this,v=t.get("gridId"),u=t.get("checkable"),y=t.get("columns"),z=t.get("width"),s=t.get("height"),w,x;if(!v){return}t._initStore();w=t.get("store");x=new d.LP.Grid({renderTo:v,width:z,height:s,checkable:u,columns:d.clone(y),forceFit:true,store:w,loadMask:true});t.set("grid",x);if(!t.get("url")){t.setData()}},_initEvent:function(){var t=this,w=t.getStore(),u=t.get("isSearch"),s,v,x;w.on("load",function(){t.fire("load",{data:t.getData()})});if(u){s=t.get("searchTip");v=t.get("searchInput");x=t.get("searchBtn");s.on("click",function(){s.hide();v[0].focus()});v.on("focus",function(){s.hide()});v.on("blur",function(){if(!v.val()){s.show()}});x.on("click",function(){var y={};y[t.get("searchKey")]=v.val();t.load(y)})}}});function e(t){var s=this;t=d.merge(e.config,t);if(!t.renderTo||!p.get("#"+t.renderTo)){throw"please assign the id of render Dom!"}e.superclass.constructor.call(s,t);s.events=["targetChange"];s._init()}e.config={renderTo:null,resultId:null,gridColumns:[],gridWidth:250,gridHeight:200,checkable:false,sourceUrl:null,sourceParam:{},sourceData:[],isSearch:true,searchTip:"",searchName:"key",searchValue:"",sourceTip:"\u53ef\u9009\u9879:",isTarget:true,targetUrl:null,targetParam:{},targetData:[],targetTip:"\u5df2\u9009\u9879:",isFilterSource:false,mainIndex:null,maxCount:null,maxFunc:function(s){alert("\u6700\u591a\u53ef\u9009\u62e9"+s+"\u9879\uff01")}};d.extend(e,d.Base);d.augment(e,{getSource:function(){return this.get("source")},getSourceStore:function(){return this.getSource().getStore()},getSourceGrid:function(){return this.getSource().getGrid()},getSourceData:function(){return this.getSource().getData()},getSourceSelectedData:function(){return this.getSource().getSelectedData()},setSourceData:function(s){this.getSource().setData(s)},sourceLoad:function(s){this.getSource().load(s)},getTarget:function(){return this.get("target")},getTargetStore:function(){return this.getTarget().getStore()},getTargetGrid:function(){return this.getTarget().getGrid()},getTargetData:function(){return this.getTarget().getData()},getTargetSelectedData:function(){return this.getTarget().getSelectedData()},setTargetData:function(s){this.getTarget().setData(s)},targetLoad:function(s){this.getTarget().load(s)},addDataFromSource:function(){var s=this,t=s.getSourceSelectedData()||[];return s._addToTarget(t)},delDateFromTarget:function(){var s=this,t=s.getTargetSelectedData()||[];return s._delFromTarget(t)},destroy:function(){var s=this,x=s.getSource(),t=s.get("container"),w=s.get("isTarget"),y,v,u;x.destroy();if(w){y=s.getTarget();v=s.get("addButton");u=s.get("addButton");y.destroy();v.detach();u.detach()}t[0].innerHTML="";s.detach();s=null},set:function(s,t){e.superclass.set.call(this,s,t,{silent:1})},_init:function(){var t=this,w=t.get("renderTo"),u=d.one("#"+w),s=t.get("resultId"),v,x=t.get("isFilterSource");t.set("container",u);if(s){v=d.one("#"+s);t.set("resultCon",v)}t._initDom();t._initEvent();if(x){t._filterSourceData()}},_initDom:function(){var A=this,t=A.get("container"),v=A.get("isTarget"),u=['<div class="',g,'"></div>'].join(""),y=v?[l,'<div class="',a,'"></div>'].join(""):"",s=['<div class="',h,'">',u,y,"</div>"].join(""),C,z,x={columns:A.get("gridColumns"),width:A.get("gridWidth"),height:A.get("gridHeight"),checkable:A.get("checkable")},B,w;t[0].innerHTML=s;C=d.get("."+g,t);A._initSource(C,x);if(v){z=d.get("."+a,t);A._initTarget(z,x);B=d.one("."+k,t);w=d.one("."+f,t);A.set("addButton",B);A.set("delButton",w)}A._setResult()},_initSource:function(t,u){var s=this,v;v=new n(d.merge(u,{container:t,url:s.get("sourceUrl"),data:s.get("sourceData"),param:s.get("sourceParam"),isSearch:s.get("isSearch"),searchTip:s.get("searchTip"),searchKey:s.get("searchName"),searchValue:s.get("searchValue"),tip:s.get("sourceTip")}));s.set("source",v);s._addMatchFunction(s.getSourceStore())},_initTarget:function(t,u){var s=this,v;v=new n(d.merge(u,{container:t,url:s.get("targetUrl"),data:s.get("targetData"),param:s.get("targetParam"),isSearch:false,tip:s.get("targetTip")}));s.set("target",v);s._addMatchFunction(s.getTargetStore())},_initEvent:function(){var s=this,t=s.get("container"),x=s.get("isTarget"),v=s.getSourceGrid(),y,w,u,z;if(x){y=s.getTargetGrid();w=s.get("addButton");u=s.get("delButton");z=s.get("isFilterSource");w.on("click",function(){s.addDataFromSource()});u.on("click",function(){s.delDateFromTarget()});v.on("rowdblclick",function(A){s._addToTarget([A.data])});y.on("rowdblclick",function(A){s._delFromTarget([A.data])});s.on("targetChange",function(A){s._setResultFromTarget()});if(z){s.getTarget().on("load",function(){s._filterSourceData()});s.getSource().on("load",function(){s._filterSourceData()});s.on("targetChange",function(A){s._filterSourceData(A.data,A.changeType)})}}else{v.on("rowselectchanged",function(A){s._setResultFromSource()})}},_addMatchFunction:function(t){var s=this,u=s.get("mainIndex");if(u){t.matchFunction=function(w,v){return w[u]===v[u]}}},_addToTarget:function(u){if(!u||!(u.length>0)){return}var s=this,t=s.getTargetStore();u=s._filterRepeatData(u);u=s._filterMaxData(u);if(u.length>0){t.add(u,true);s.fire("targetChange",{changeType:"add",data:u})}return u},_filterRepeatData:function(u){var s=this,w=s.getTargetData(),v=s.get("mainIndex"),t=[];d.each(u,function(y){var x=false;d.each(w,function(z){if((v&&z[v]===y[v])||(!v&&z===y)){x=true;return false}});if(!x){t.push(y)}});return t},_filterMaxData:function(x){var s=this,t=s.getTargetStore(),w=s.get("maxCount"),u=t.getCount(),v=x;if(d.isNumber(w)&&u+x.length>w){v=x.slice(0,w-u);s.get("maxFunc")(w)}return v},_delFromTarget:function(u){if(!u||!(u.length>0)){return}var s=this,t=s.getTargetStore();t.remove(u);s.fire("targetChange",{changeType:"del",data:u});return u},_filterSourceData:function(u,t){var s=this,v=s.getSourceStore();if(t==="add"){v.remove(u)}else{if(t==="del"){v.add(u,true)}else{v.remove(s.getTargetData())}}},_setResult:function(v){var s=this,t=s.get("isTarget"),u=s.get("resultCon");if(!u){return}if(v){u.val(d.JSON.stringify(v))}else{if(t){s._setResultFromTarget()}else{s._setResultFromSource()}}},_setResultFromSource:function(){var s=this,t=s.get("resultCon");if(t){t.val(d.JSON.stringify(s.getSourceSelectedData()))}},_setResultFromTarget:function(){var s=this,t=s.get("resultCon");if(t){t.val(d.JSON.stringify(s.getTargetData()))}}});d.namespace("LP");d.LP.SelectGrid=n;d.LP.GroupSelect=e},{requires:["1.0/grid","lpmodule/css/module.css"]});
