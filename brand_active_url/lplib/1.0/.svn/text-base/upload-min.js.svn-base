KISSY.add(function(b){var c=b.DOM,d=b.Event;var a=function(g){var f={mode:"single",uploadType:"asyn",extendName:[],params:{},url:"",selectBtnText:"\u6d4f\u89c8",uploadBtnText:"\u5f00\u59cb\u4e0a\u4f20",renderTo:"body",fileName:"file"};var e=this;var h=b.merge(f,g);a.superclass.constructor.call(e,h);b.mix(e,h);e._init()};b.extend(a,b.Base);b.augment(a,{msg:"Loading...",NOT_FOUND_NODE:"\u5bf9\u4e0d\u8d77,\u7ed1\u5b9a\u65f6\uff0c\u627e\u4e0d\u5230\u7ed1\u5b9a\u8282\u70b9.",NOT_VALID_EXTENDNAME:" \u5bf9\u4e0d\u8d77\uff0c\u6587\u4ef6\u540e\u7f00\u540d\u4e0d\u7b26\u5408\u89c4\u5219\uff01",_html:function(){var f=this;var i=b.one(f.renderTo);f.set("container",i);if(i===null){f.exception(f.NOT_FOUND_NODE);return}var k=b.guid(),g="?",j="{",h="";f.set("_id_guid",k);for(var e in f.params){g+="&"+e+"="+f.params[e];j+="'"+e+"':'"+f.params[e]+"',"}j=j.substring(0,j.length-1);j+="}";h=f._initTemplate(k,g,j);f.set("pubid",k);b.one(c.create(h)).appendTo(i)},_initTemplate:function(j,f,i){var e=this,h="",g="@";h+='<div class="uploadArea" id="uploadArea-'+j+'" ><span class="file-field-container"><input id="lp_file_'+j+'" class="fileInput" type="file" style="width: 94px; height: 22px; display: block;" hidefocus="true" name="'+e.fileName+'" size="3" /><a class="btn-small-container " href="javascript:void(0);"  id="browserBtn_'+j+'"><button  type="button" class="form-field-button btn-small">\u6dfb\u52a0\u4e0a\u4f20\u6587\u4ef6</button></a>'+g+"</span></div>";h+='<div class="uploadteam" id="uploadteam-'+j+'"><p id="file-team-'+j+'"><label id="file-label-'+j+'" class="file-label"></label></p></div>';if(e.uploadType!=="normal"){h=h.replace("@",'<a class="btn-small-container " href="javascript:void(0);"  id="submit_upload_'+j+'" style="display:none;"><button  type="submit" class="form-field-button btn-small">\u4e0a\u4f20</button></a>');h='<iframe name="iframe_upload_'+j+'" id="J_iframe_upload_'+j+'" style="display:none;" ></iframe><form  data-break="false" action="'+e.url+f+'" target="iframe_upload_'+j+'" method="post" enctype="multipart/form-data" id="hid_form_'+j+'"><input type="hidden" name="J_hid_upload" value="'+i+'" id="J_hid_upload" />'+h+"</form>"}else{h=h.replace("@","")}h=h.replace("?&","?");return h},breakUpload:function(){var e=this,f=e.get("pubid");c.attr("#hid_form_"+f,"data-break","true")},clearFiles:function(){var f=this,g=f.get("pubid");var h=c.query(".fileInput","#uploadArea-"+g),e=c.query("p","#uploadteam-"+g);b.each(h,function(j,i){if(i>0){c.remove(j)}});b.each(e,function(j,i){if(i>0){c.remove(j)}});c.css("#submit_upload_"+g,{display:"none"})},getUploadFileCount:function(){var e=this,f=e.get("pubid"),g=c.query(".fileInput","#uploadArea-"+f);return g.length-1},_beforeUpload:function(){var e=this;e.fire("beforeUpload")},_upload:function(){var e=this;e._multipleUpload();var f=e.get("pubid");d.on("#submit_upload_"+f,"click",function(){c.attr("#hid_form_"+f,"data-break","false");e._beforeUpload();if(c.attr("#hid_form_"+f,"data-break")==="true"){return false}var h=c.query(".fileInput","#uploadArea-"+f);var g=c.query("p","#uploadteam-"+f);if(e.mode!=="single"){c.remove(h[0]);c.remove(g[0])}e._finishUpload()})},_multipleUpload:function(){var e=this;d.on("#lp_file_"+e.get("_id_guid"),"change",function(){e._multipleFileChange(this)})},_addUploadFile:function(){var e=this,l=b.guid(),h=e.get("pubid"),g=c.children("#uploadArea-"+h)[0],j=b.get("#uploadteam-"+h);var i=c.create('<input id="lp_file_'+l+'" class="fileInput" type="file" style="width: 94px; height: 22px; display: block;" hidefocus="true" name="'+e.fileName+'" size="3" />');c.prepend(i,g);var f=e.get("_id_guid"),k=c.create('<p id="file-team-'+l+'"><label id="file-label-'+l+'" class="file-label"></label></p>');c.prepend(k,j);e.set("_id_guid",l);d.on("#lp_file_"+l,"change",function(){e._multipleFileChange(this)})},_multipleFileChange:function(j){var g=this;var f=g._checkfile(j);if(f){var l=j.value.split("\\"),k=g.get("_id_guid");var h=g.get("pubid");c.html("#file-label-"+k,l[l.length-1]+'<a class="file-cancel-upload" id="file-cancel-upload-'+k+'" href="javascript:void(0)" title="\u5220\u9664\u6587\u4ef6"></a>');if(g.mode!=="single"){c.css(j,{display:"none"})}d.on("#file-cancel-upload-"+k,"click",function(){c.remove("#lp_file_"+k);c.remove("#file-team-"+k);var m=c.query(".file-label","#uploadteam-"+h);if(m.length<2){c.css("#submit_upload_"+h,{display:"none"})}if(g.mode==="single"){g._addUploadFile()}g.fire("removefile")});var i=c.query(".file-label","#uploadteam-"+h);var e=1;if(g.mode!=="single"&&g.get("max")){e=g.get("max")}if(/^[1-9]\d*$/.test(e)){var i=c.query(".file-label","#uploadteam-"+h);if(i.length>e){if(g.mode!=="single"){g._removefile(j);b.LP.Message.Alert("error","\u5bf9\u4e0d\u8d77\uff0c\u60a8\u4e00\u6b21\u53ea\u80fd\u4e0a\u4f20"+e+"\u4e2a\u6587\u4ef6")}}else{if(g.mode!=="single"){g._addUploadFile()}g.fire("afterselectfile")}}c.css("#submit_upload_"+h,{display:"inline-block"})}else{b.LP.Message.Alert("error","\u5bf9\u4e0d\u8d77\uff0c\u4f60\u53ea\u80fd\u4e0a\u4f20"+g.extendName+" \u4e3a\u540e\u7f00\u7684\u6587\u4ef6")}},_checkfile:function(f){var e=this;if(!RegExp(".("+e.extendName.join("|")+")$","i").test(f.value)){if(e.mode!=="single"){e._removefile(f)}return false}else{return true}},_checkIsHasFile:function(e){},_removefile:function(g){var e=this;var h=g.id,f=h.split("_")[2];e._addUploadFile();c.remove("#lp_file_"+f);c.remove("#file-team-"+f)},_finishUpload:function(){var e=this,f=e.get("pubid");d.on("#J_iframe_upload_"+f,"load",function(){c.css("#submit_upload_"+f,{display:"none"});b.get("#hid_form_"+f).reset();var k=c.query(".fileInput","#uploadArea-"+f);b.each(k,function(m,l){c.remove(m)});var j=c.query("p","#uploadteam-"+f);b.each(j,function(m,l){c.remove(m)});e._addUploadFile();var i=this.contentWindow.document,g=i.body||i.documentElement;var h=g.innerHTML;if(h.length!==0){e.fire("uploadCompeleted",{msg:c.text(g)})}d.detach("#J_iframe_upload_"+f,"load")})},_init:function(){var e=this;e._requireMessage();e._html();e._upload()},_requireMessage:function(){var e=b.LP.version==="2.0"?"2.0":"1.0";b.use(e+"/message")},setParams:function(h){var f=this,g="?",i="{";for(var e in h){g+="&"+e+"="+h[e];i+="'"+e+"':'"+h[e]+"',"}i=i.substring(0,i.length-1);i+="}";g=g.replace("?&","?");c.attr("#hid_form_"+f.get("_id_guid"),"action",f.url+g);c.attr("#J_hid_upload","value",i)},exception:function(e){b.log(e)}});b.namespace("LP");b.LP.Upload=a},{requires:["core","./css/upload.css"]});
