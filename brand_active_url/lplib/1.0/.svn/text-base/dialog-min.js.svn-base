KISSY.add(function(c){var d=c.DOM,a=c.Event,f=window,e=document;function b(h){var g=this;if(!(g instanceof b)){return new b(h)}var i={width:200,height:200,minWidth:300,minHeight:200,title:"Title",mask:true,scroll:true,collapsible:false,maximizable:false,resizable:false,drag:true,dropZone:e.body,buttonZone:true,buttonPosition:"center",template:null,closeBtn:"ks-close",contentType:"custom",contentID:"ks-userTemplate",isDestroy:true};h=c.merge(i,h);b.superclass.constructor.call(g,h);g._init()}c.extend(b,c.Base);b.ATTRS={isMousedown:{value:false},userContentTemplate:{value:null},mouseX:{value:null},mouseY:{value:null},elmX:{value:null},elmY:{value:null},windowID:{value:null},ZIndex:{value:9000},topZIndex:{value:9100},dragZIndex:{value:10000},hasInitEvent:{value:true}};c.augment(b,{_init:function(){var g=this;g.set("windowID","ks-dialog-"+(new Date).getTime()+Math.round(Math.random()*10000));g._selectTemplateType(g.get("contentType"));g.set("template",g._window())},_initStruct:function(){},_initEvent:function(){var g=this,i,h;c.one("#"+g.get("windowID")+" ."+g.get("closeBtn")).on("click",g.close,g);c.one("#"+g.get("windowID")).on("click",g._toTop,g);if(g.get("drag")){c.one("#"+g.get("windowID")+" .x-panel-header-draggable").on("mousedown",g._drag,g);c.one(e).on("mousemove",g._drag,g)}if(g.get("collapsible")){c.one("#"+g.get("windowID")+" .x-tool-collapse-top").on("click",g._collapsible,g)}if(g.get("buttonZone")){i=d.get("#"+g.get("windowID")+" .x-toolbar-footer");h=g.get("buttons");(function(){var j=0;for(j;j<i.children.length;j++){if(h[j].handler&&h[j].eventType){c.one(i.children[j]).on(h[j].eventType,h[j].handler,g)}}})()}},_position:function(){var l,k,j,i,h,m,g=this;j=d.viewportWidth();i=d.viewportHeight();l=g.get("width");k=g.get("height");h=d.scrollLeft(d.get("window"));m=d.scrollTop(d.get("window"));return{tc:function(){var o,n;n=h+(j-l)/2;o=m+(i-k)/2;if(n<0){n=0}else{if(o<0){o=0}}return{top:o,left:n}}}},_drag:function(k){var g=this,j=c.one("#"+g.get("windowID"));if(k.type==="mousedown"){j.addClass("window-opacity");g.set("mouseX",parseInt(k.clientX));g.set("mouseY",parseInt(k.clientY));g.set("elmX",parseInt(j.css("left")));g.set("elmY",parseInt(j.css("top")));g.set("isMousedown",true);e.getElementById(g.get("windowID")).style.zIndex=g.get("dragZIndex");c.one(e).on("mouseup",g._drag,g)}if(k.type==="mouseup"){j.removeClass("window-opacity");g.set("isMousedown",false);e.getElementById(g.get("windowID")).style.zIndex=g.get("ZIndex");c.one(e).detach("mouseup")}if(k.type==="mousemove"&&g.get("isMousedown")==true){var i,h;i=k.clientY-g.get("mouseY")+g.get("elmY");h=k.clientX-g.get("mouseX")+g.get("elmX");k.clientY>0?j.css("top",i+"px"):j.css("top","0px");j.css("left",h+"px")}},_collapsible:function(){var g=this,k="easeNone",h=c.get("#"+g.get("windowID")+" .window-default"),j=c.get("#"+g.get("windowID")),i=c.get("#"+g.get("windowID")+" .J_collapse");if(!c.Anim.isRunning(h)&&!c.Anim.isRunning(j)){if(d.hasClass(i,"x-tool-collapse-top")){d.style(h,"overflow","hidden");c.Anim(h,{height:"18px"},0.2,k,function(){d.replaceClass(i,"x-tool-collapse-top","x-tool-collapse-bottom")}).run();c.Anim(j,{height:"28px"},0.2,k,function(){d.replaceClass(i,"x-tool-collapse-top","x-tool-collapse-bottom")}).run()}else{d.style(h,"overflow","");c.Anim(h,{height:g.get("height")-10},0.2,k,function(){d.replaceClass(i,"x-tool-collapse-bottom","x-tool-collapse-top")}).run();c.Anim(j,{height:g.get("height")},0.2,k,function(){d.replaceClass(i,"x-tool-collapse-bottom","x-tool-collapse-top")}).run()}}},_toTop:function(k){var g=this,h;h=d.query(".ks-window-css-shadow");for(var j=0;j<h.length;j++){h[j].style.zIndex=g.get("ZIndex")}k.currentTarget.style.zIndex=g.get("topZIndex")},_mask:function(){var g=this;if(g.get("mask")){c.LP.mask()}},_window:function(k){var g,m,n,j,i,h,l;g=this;k={windowID:g.get("windowID"),closeBtn:g.get("closeBtn"),title:g.get("title"),cssShadowWidth:g.get("width"),cssShadowHeight:g.get("height"),windowDefaultWidth:g.get("width")-10,windowDefaultHeight:g.get("height")-10,buttonZone:g.get("buttonZone"),drag:g.get("drag"),scroll:g.get("scroll"),userContentTemplate:g.get("userContentTemplate"),buttons:g.get("buttons"),buttonPosition:g.get("buttonPosition"),maximizable:g.get("maximizable"),collapsible:g.get("collapsible"),ZIndex:g.get("ZIndex")};j='<div class="ks-window-css-shadow" id="{{windowID}}" style="width:{{cssShadowWidth}}px;height:{{cssShadowHeight}}px;position:absolute;z-index:{{ZIndex}};overflow:hidden;"><div class="window-default" style="width:{{windowDefaultWidth}}px;height:{{windowDefaultHeight}}px;"><div class="ks-clear {{#if drag}}x-panel-header-draggable{{/if}}"><div class="x-component x-component-default x-window-header-title"> <span class="x-window-header-text x-window-header-text-default">{{title}}</span> </div><div class="x-window-header-tools"> {{#if collapsible}}<span class="x-tool x-tool-default"><img class="x-tool-collapse-top J_collapse" src="http://img02.taobaocdn.com/tps/i2/T1dOl5XnRwXXXXXXXX-1-1.gif"></span>{{/if}}{{#if maximizable}}<span class="x-tool x-tool-default"><img class="x-tool-maximize" src="http://img02.taobaocdn.com/tps/i2/T1dOl5XnRwXXXXXXXX-1-1.gif"></span><span class="x-tool x-tool-default" style="display:none"><img class="x-tool-restore" src="http://img02.taobaocdn.com/tps/i2/T1dOl5XnRwXXXXXXXX-1-1.gif"></span>{{/if}}<span class="x-tool x-tool-default {{closeBtn}}"><img class="x-tool-close" src="http://img02.taobaocdn.com/tps/i2/T1dOl5XnRwXXXXXXXX-1-1.gif"> </span></div></div><div class="x-window-body-default ks-clear" style="height:{{#if buttonZone}}{{cssShadowHeight - 60}}{{#else}}{{cssShadowHeight - 32}}{{/if}}px;width:{{windowDefaultWidth - 2}}px;{{#if scroll}}overflow:auto{{/if}}">';i="{{userContentTemplate}}";h='</div>{{#if buttonZone}}<div class="x-toolbar-footer" style = "text-align:{{buttonPosition}}">{{#each buttons as buttons}}<span class="x-btn x-btn-default-small"><button autocomplete="off" hidefocus="true" type="button">{{buttons.text}}</button></span>{{/each}}</div>{{/if}}</div><iframe style="width:{{cssShadowWidth}}px;height:{{cssShadowHeight}}px; border: 0 none;position:absolute;left:0;top:0"></iframe></div>';if(typeof k.userContentTemplate==="string"){n=j+i+h;m=c.Template(n).render(k);return d.create(m)}else{n=j+h;l=d.create(c.Template(j+h).render(k));c.one(l).one(".x-window-body-default").append(k.userContentTemplate);return l}},_selectTemplateType:function(h){var g=this;switch(h){case"custom":g.set("userContentTemplate",g.templataLib.custom.call(this,g.get("contentID")));break;default:}},_setPosition:function(){var h=this,g=h._position().tc();c.one("#"+h.get("windowID")).css({left:g.left,top:g.top})},show:function(){var g=this,h,j,k;if(!d.get("#"+g.get("windowID"))){g.get("dropZone").appendChild(g.get("template"));if(typeof g.get("userContentTemplate")==="string"){k=d.get("#"+g.get("windowID"));h=k.getElementsByTagName("script");for(j=0;j<h.length;j++){c.globalEval(h[j].text)}}if(g.get("hasInitEvent")){g._initEvent();g.set("hasInitEvent",false)}g._mask();g._setPosition();g.fire("onShow",{dialog:g,template:g.get("template")})}else{c.Anim(g.get("template"),{opacity:"0.5"},0.1,"easeNone",function(){c.Anim(g.get("template"),{opacity:"1"},0.1,"easeNone").run()}).run()}},close:function(){var g=this,h=e.getElementById(g.get("contentID"));if(g.get("isDestroy")){if(g.get("userContentTemplate")){if(typeof g.get("userContentTemplate")==="string"){h.value=g.get("userContentTemplate")}else{c.one(h).append(c.one("#"+g.get("windowID")).one(".x-window-body-default").children())}}g.fire("onDestroy",{dialog:g});g.detach();d.remove(g.get("template"));g.set("template",null);g.set("userContentTemplate",null)}else{g.fire("onHidden",{dialog:g});g.get("template").parentNode.removeChild(g.get("template"))}if(g.get("mask")){c.LP.unmask()}},templataLib:{custom:function(j){var g=this,i,h=e.getElementById(j);if(!h){throw"Please specify the contentID"}if(h.type==="textarea"){i=h.value}else{i=h.children}g.on("onClose",function(k){if(!(h.type==="textarea")){}else{h.value=i}});return i}}});c.namespace("LP");c.LP.Dialog=b},{requires:["core","uibase","template","./uicommon","./css/dialog.css","./css/uicommon.css"]});
