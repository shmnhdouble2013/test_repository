KISSY.add(function(e,g){var k=e.DOM,j="work-flow",i="#c8cbcf",f="#bbbdc0",d="node-info-container",b=d+"-selected",a="http://www.w3.org/2000/svg";var h=function(l){h.superclass.constructor.call(this,l);this._init()};h.ATTRS={actionRadio:{value:5},lineCurve:{value:10},lineAttr:{value:{fill:"none",stroke:f,"stroke-width":2}},lineTag:{value:"line"},nodeAttr:{value:{fill:i}},nodes:{value:[]},nodeTag:{value:"circle"},lines:{value:[]},lineColor:{value:"blue"},pathTag:{value:"path"},pathAttr:{value:"d"},renderTo:{},rootDom:{},rootTag:{value:"svg"},titleTpl:{},width:{value:500},height:{value:200},xCell:{value:100},yCell:{value:40},cutline:{value:""}};e.extend(h,e.Base);e.augment(h,{_appendElement:function(p,m,o){var l=this,n=l._createElement(p);k.attr(n,m);k.appendTo(n,o);return n},_createElement:function(l){return document.createElementNS(a,l)},_createNodeInfo:function(z,C){var o=this,D=z.title,A=z.info,t=z.infoPos,w=o.get("container"),u=o.get("nodesTemplate"),q=w.offset(),r=C.offset(),x=r.top-q.top,p=r.left-q.left,s=o.get("actionRadio")+10,B=null;if(!D){return}B='<div class="node-title-container">'+D+"</div>";var l=new e.Node(B).appendTo(w);l.css({top:x-s,left:p});if(A&&u){var m=u[z.id],y=t==1?"x-caret-down":"x-caret-up";if(m){B='<div class="node-info-container"><span class="x-caret '+y+'"></span>'+g(m).render(A)+"</div>";var v=new e.Node(B).appendTo(w);if(t===1){var n=v.outerHeight();v.css({top:x-(n+s+10),left:p});v.addClass("node-pos-top")}else{v.css({top:(x+s+10),left:p})}}}},_getRootConfig:function(){var m=this,n=m.get("width"),l=m.get("height"),o={width:n,height:l,viewBox:"0 0 "+n+" "+l};return o},_init:function(){var l=this;l._initDom();l._initNodes();l._initLines();l._initEvent();l._initCutline()},_initDom:function(){var l=this,o=l.get("rootDom"),p=l.get("renderTo"),m=e.one("#"+p),n=l._getRootConfig();l.set("container",m);if(!o){o=l._appendElement(l.get("rootTag"),n,m);l.set("rootDom",o)}m.addClass("flow-chart");m.css({position:"relative"})},_getNode:function(o){var m=this,n=m.get("nodes"),l=null;e.each(n,function(p){if(p.id==o){l=p;return false}});return l},_getNodeConfig:function(m){var l=this,n=l.get("nodeAttr"),o=e.merge(n,{cx:l._getX(m.x),cy:l._getY(m.y),r:l.get("actionRadio")},m.attrs);return o},_getX:function(m){var l=this,n=l.get("actionRadio");return m*l.get("xCell")+n},_getY:function(n){var l=this,m=l.get("actionRadio");return n*l.get("yCell")+m},_getPosition:function(m){var l=this;return{x:l._getX(m.x),y:l._getY(m.y)}},_initEvent:function(){var l=this,m=l.get("container");m.delegate("click","."+d,function(o){var n=e.one(o.currentTarget);l._clearInfoSelected();n.addClass(b)})},_clearInfoSelected:function(){var l=this,m=l.get("container");m.all("."+b).removeClass(b)},_initNodes:function(){var l=this,m=l.get("nodes");e.each(m,function(n){l._initNode(n)})},_initNode:function(n){var l=this,o=l._getNodeConfig(n),m=l._appendElement(l.get("nodeTag"),o,l.get("rootDom"));if(n.css){k.addClass(m,n.css)}l._createNodeInfo(n,e.one(m))},_initLines:function(){var l=this,m=l.get("lines");e.each(m,function(o){var p=l._getNode(o.begin),r=l._getPosition(p),n=l._getNode(o.end),q=l._getPosition(n);if(p.y==n.y||p.x==n.x){l._createLine(r,q,o.attrs)}else{l._createPath(r,q,o.attrs)}})},_getLineConfig:function(q,p,o){var l=this,n=l.get("actionRadio"),m=e.merge(l.get("lineAttr"),{x1:q.x+n,y1:q.y,x2:p.x-n,y2:p.y},o);return m},_createLine:function(p,o,n){var l=this,m=l._getLineConfig(p,o,n);l._appendElement(l.get("lineTag"),m,l.get("rootDom"))},_createPath:function(q,o,n){var l=this,p=l._getPathPoints(q.x,q.y,o.x,o.y),m=e.merge(l.get("lineAttr"),n);m[l.get("pathAttr")]=p.join(" ");l._appendElement(l.get("pathTag"),m,l.get("rootDom"))},_getPathPoints:function(n,u,m,t){var s=this,l=s.get("actionRadio"),q=s.get("lineCurve"),v=[],p=Math.floor(n+(m-n)/2-q),w=p+q,o=t>u?1:-1;v.push("M "+(n+l)+","+u);v.push("L "+p+","+u);v.push("C "+[w,u,w,u,w,u+(q*o)].join(" "));v.push("L "+w+","+(t-(q*o)));v.push("C "+[w,t,w,t,w+q,t].join(" "));v.push("L"+(m-l)+","+t);return v},_initCutline:function(){var l=this,m=l.get("container"),n=l.get("cutline");if(!!n){m.prepend('<div class="node-info-container workflow-cutline"><img src="'+n+'"/></div>')}},destroy:function(){var l=this,m=l.get("container");m.children().remove();m.undelegate();l.detach();l.__attrVals={}}});var c=function(l){c.superclass.constructor.call(this,l)};c.ATTRS={nodeAttr:{value:{filled:true,FillColor:i,StrokeColor:i}},pathAttr:{value:"path"},rootTag:{value:"div"},elementNS:{value:""},lineAttr:{value:{StrokeColor:f,StrokeWeight:2,FillOpacity:0}},nodeTag:{value:"v:oval"},lineTag:{value:"v:line"},pathTag:{value:"v:shape"}};e.extend(c,h);e.augment(c,{_createElement:function(l){return document.createElement(l)},_createPath:function(q,p,s){var o=this,n=o.get("actionRadio"),r=o._getPathPoints(q.x+n,q.y+n,p.x+n,p.y+n),m=Math.abs(p.x-q.x),t=Math.abs(p.y-q.y),l={position:"absolute",width:m+"px",height:t+"px"},u=e.merge(o.get("lineAttr"),{style:o._getStyle(l)},s,{CoordSize:m+","+t});u[o.get("pathAttr")]=r.join(" ");e.log(r.join(" "));o._appendElement(o.get("pathTag"),u,o.get("rootDom"))},_getLineConfig:function(q,p,o){var l=this,n=l.get("actionRadio"),r={position:"absolute"},m=e.merge(l.get("lineAttr"),{from:(q.x+n*2)+","+(q.y+n),to:(p.x)+","+(p.y+n)},{style:l._getStyle(r)},o);return m},_getNodeConfig:function(n){var l=this,m=l.get("actionRadio"),o=l.get("nodeAttr"),p={position:"absolute",left:l._getX(n.x)+"px",top:l._getY(n.y)+"px",width:m*2+"px",height:m*2+"px"},q=e.merge(o,{style:l._getStyle(p)},n.attrs);return q},_getRootConfig:function(){var l=this,m={width:l.get("width")+"px",height:l.get("height")+"px"};return{style:l._getStyle(m),"class":j}},_getStyle:function(n){var l=[];for(var m in n){if(n.hasOwnProperty(m)){l.push(m+":"+n[m])}}return l.join(";")}});h.vml=c;return h},{requires:["template"]});
