KISSY.add(function(d,b){var a=d.Event,g=d.DOM;var f="J_Thumbnail",h=500,c=500;function e(i){i=d.merge({maxW:h,maxH:c},i);e.superclass.constructor.call(this,i);this._init()}d.extend(e,d.Base);d.augment(e,{_getLinkItems:function(){var j=this,k=j.get("el"),i;if(k){i=k.all("."+f)}else{i=j.get("nodeData")}return i},_getCurrentItem:function(){var i=this;return i.get("currentItem")},_getItemIndex:function(n,k){var l=-1,j,m;if(k.each){k.each(function(o,i){if(o[0]===d.one(n)[0]){l=i;return false}})}else{j=k.length;for(m=0;m<j;m++){if(k[m]===n){l=m}}}return l},_getNextItem:function(m,k){var j=this,i=-1,l;m=m||j._getCurrentItem();k=k||j._getLinkItems();i=j._getItemIndex(m,k);l=m.imgSrc?k[i+1]:k[i+1];return l},_getPrevItem:function(m,k){var j=this,i=-1,l;m=m||j._getCurrentItem();k=k||j._getLinkItems();i=j._getItemIndex(m,k);l=m.imgSrc?k[i-1]:k[i-1];return l},_init:function(){var i=this;i._initDom();i._initOverlay();i._initEvent()},_initDom:function(){var i=this,k=d.one(i.get("srcNode")),j=i.get("nodeData");if(k){i.set("el",k)}else{if(j){i.set("nodeData",j)}}},_initOverlay:function(){var i=this,j=new b({content:'<div class="oi-outer"><div class="oi-data"><div class="oi-title"></div><div class="oi-numer"></div><a href="#" class="close">\u00d7</a></div><div class="oi-container" unselected="on" title="\u7528\u65b9\u5411\u952e\u5de6\u53f3\u952e\u5207\u6362\uff0cEsc\u952e\u9000\u51fa"><img class="oi-loading" src="http://lokeshdhakar.com/projects/lightbox2/images/loading.gif" /><img class="oi-img" src="http://lokeshdhakar.com/projects/lightbox2/images/loading.gif"/><div class="oi-nav" style="display: block; "><a class="oi-prev" style="display: block; "></a><a class="oi-next" style="display: block; "></a></div></div></div>',effect:{effect:"fade",duration:0.5},align:{points:["cc","cc"]},width:i.get("maxW"),height:i.get("maxH"),closable:false,mask:true});i.set("overlay",j)},_initEvent:function(){var i=this;i._bindImage();i._bindKeyboard()},_bindImage:function(){var i=this,k=i.get("el"),j=i.get("overlay");if(k){i._delegateImgClickEvent(k)}j.on("afterRenderUI",function(){l();i._bindOverlay()});function l(){var n=j.get("el"),m;a.on(n.one(".oi-img"),"load",function(){i._limitImgWidth();n.one(".oi-img").show();d.one(".oi-loading",n).hide();i.set("hasLoad",true)});a.on(n.one(".oi-img"),"error",function(){m="http://img04.taobaocdn.com/tps/i4/T1sz38XlFaXXcMejYy-500-270.jpg";n.one(".oi-img").attr("src",m);i.set("hasLoad",true)})}},_delegateImgClickEvent:function(j){var i=this;a.on(j,"imageload",function(m){var l=i.get("overlay"),k=l.get("el");if(!i.get("hasLoad")){return}i._limitImgWidth();k.one(".oi-img").show();d.one(".oi-loading",k).hide()});j.delegate("click","."+f,function(k){var l=k.currentTarget;k.halt();i._showItem(l)})},_showItem:function(l){if(!l){return}var i=this,m=l.imgSrc||d.one(l).attr("imgSrc"),k=i.get("el"),j=i.get("overlay");if(!j.get("visible")){j.center();j.show()}i._setImageInfo(l)},_setImageInfo:function(n){var j=this,k=j.get("overlay"),i=k.get("el"),m=i.one(".oi-img"),o,l;j._showLoading(i);o=n.imgSrc||d.one(n).attr("imgSrc");m.css("width","auto");m.css("height","auto");m.hide();m.attr("src",o);j._setPagination(n,i);j._setPageTurnBtn(n,i);l=j._getCurrentItem();j._resetLoadFlag(l,o);j.set("currentItem",n);if(j.get("nodeData")){a.fire(k,"showNode")}else{a.fire(n,"imageload")}},_showLoading:function(i){d.one(".oi-loading",i).show();d.one(".oi-loading",i).css({position:"absolute",zIndex:"50",left:"50%",top:"50%",marginLeft:"-16px"})},_setPagination:function(n,k){var m=this,j=m.getCurrentIndex(n),i=m.getTotalCount(),l=(j+1)+"/"+i;k.one(".oi-numer").text(l)},_setPageTurnBtn:function(o,l){var m=this,n=l.one(".oi-prev"),i=l.one(".oi-next"),k=m.getCurrentIndex(o),j=m.getTotalCount();if(k===0){n.hide()}if(k===(j-1)){i.hide()}if(k>0){n.show()}if(k<(j-1)){i.show()}},_resetLoadFlag:function(j,k){var i=this;if(j){j=j.imgSrc?j:d.one(j);if(j.imgSrc===k||(j.attr&&j.attr("imgSrc")===k)){i.set("hasLoad",true)}else{i.set("hasLoad",false)}}else{i.set("hasLoad",false)}},_limitImgWidth:function(){var k=this,l=k.get("overlay"),i=l.get("el"),m=i.one(".oi-img"),j=m.width();imgHeight=m.height();h=k.get("maxW");c=k.get("maxH");if((j>h)&&(imgHeight>c)){if(j>imgHeight){m.css("width",h+"px")}else{m.css("height",c+"px")}}else{m.css("width",(j>=h?h:j)+"px");m.css("height",(imgHeight>=c?c:imgHeight)+"px")}i.one(".oi-outer").css("width",m.width()+"px")},_bindOverlay:function(){var i=this,j=i.get("overlay");i._bindShowNode(j);i._bindClose(j);i._overlayHover(j);i._overlayUnselectable(j);i._bindImgPageTurning(j);i._bindHide(j)},_bindShowNode:function(k){var j=this,i=k.get("el");a.on(k,"showNode",function(){if(!j.get("hasLoad")){return}j._limitImgWidth();i.one(".oi-img").show();d.one(".oi-loading",i).hide()})},_bindClose:function(j){var i=j.get("el");i.delegate("click",".close",function(k){k.halt();j.hide()})},_overlayHover:function(l){var k=this,j=l.get("el"),m=j.one(".oi-prev"),i=j.one(".oi-next");a.on(j.one(".oi-container"),"mouseenter mouseleave",function(n){m.toggleClass("oi-prev-hover");i.toggleClass("oi-next-hover")})},_overlayUnselectable:function(j){var i=j.get("el");a.on(i.one(".oi-container"),"selectstart",function(){return false})},_bindImgPageTurning:function(l){var k=this,j=l.get("el"),m=j.one(".oi-prev"),i=j.one(".oi-next");m.on("click",function(o){o.halt();var n=k._getPrevItem();k._showItem(n);k._setPageTurnBtn(n,j)});i.on("click",function(o){o.halt();var n=k._getNextItem();k._showItem(n);k._setPageTurnBtn(n,j)})},_bindHide:function(k){var j=k.get("el"),l=j.one(".oi-prev"),i=j.one(".oi-next");k.on("hide",function(){l.show();i.show()})},_bindKeyboard:function(){var i=this,j=i.get("overlay");a.on(window.document,"keydown",function(m){var n=j.get("visible"),l;if(!n){return}m.halt();l=m.keyCode;switch(l){case 27:j.hide();break;case 37:k(37);break;case 39:k(39);break}});function k(l){var n=(l===39),m;if(n){m=i._getNextItem();i._showItem(m)}else{m=i._getPrevItem();i._showItem(m)}}},getCurrentIndex:function(k){var j=this,i=j._getLinkItems();return j._getItemIndex(k,i)},getTotalCount:function(){var j=this,i=j._getLinkItems();return i.length},show:function(){var j=this,i=j._getLinkItems();if(j.get("nodeData")){j._showItem(i[0])}},changeData:function(j){var i=this,j=j||{};if(j.nodeData){i.set("nodeData",j.nodeData)}}});return e},{requires:["overlay"]});
