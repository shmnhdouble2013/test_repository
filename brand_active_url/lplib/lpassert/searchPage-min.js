KISSY.add(function(f,q){var g=f.app("pageUtil"),s=f.Event,k=f.UA;var b="form-line",i="row",e="ks-hidden",c="icon-down",l="icon-up",o="stretch-box",j="stretch-line",p=13,r=5;var h=function(u){var t=this;u=f.merge({formId:"searchForm",btnId:"btnSearch",autoSearch:true,validator:function(){return true},isCrossPage:true},u);h.superclass.constructor.call(t,u);t._init()};f.extend(h,f.Base);f.augment(h,{_getLastVisibleLine:function(){var u=this,v=f.all("."+b,u.form),t=null;if(!v||v.length===0){v=f.all("."+i,u.form)}v.each(function(w){if(u._isShow(w)){t=w}});return t},_isShow:function(t){var u=f.one(t);return u.css("visibility")!=="hidden"&&u.height()>0},_init:function(u){var t=this,z=t.get("gridConfig"),x=z.autoFit,y=f.DOM.get("#"+t.get("formId")),w=f.one("#"+t.get("btnId")),v=null;if(t.get("groupGrid")){v=new f.LP.GroupGrid(z)}else{if(t.get("editGrid")){v=new f.LP.EditGrid(z)}else{v=new f.LP.Grid(z)}}t.store=t.get("store");t.grid=v;t.form=y;t.btn=w;t.autoFit=x;t.renderTo=z.renderTo;t._initFormFocus();t._initEvent();if(t.get("autoSearch")){t._getData(true)}},_initFormFocus:function(){var t=this,u=f.one(t.form);u.attr("tabindex",0);if(k.ie){u.attr("hideFocus",true)}else{u.css({outline:"none"})}},_initEvent:function(){var t=this;t._initFormEvent();t._initGridEvent();t._initStrethEvent();t._initDataEvent();t._initResizeEvent()},_initFormEvent:function(){var t=this,u=t.get("validator");t.btn.on("click",function(v){v.preventDefault();if(u()){t._getData(true)}});f.all("textarea",t.form).on("keydown",function(v){if(v.keyCode===p){v.stopPropagation()}});s.on(t.form,"keydown",function(v){if(v.keyCode===p){if(u()){t._getData(true)}}})},_initGridEvent:function(){var t=this,u=t.grid;u.on("aftershow",function(){f.all(".grid-command","#"+t.renderTo).on("click",function(z){z.preventDefault();var w=f.one(this),v=w.attr("data-href"),B=w.attr("data-id"),x=w.attr("data-type"),y=w.attr("data-module"),A=w.attr("data-title");if(w.hasClass("command-btn")){return}if(t.get("isCrossPage")&&top.pageManger){top.pageManger.openPage(y,x+B,A,v,function(){t._getData()});return false}})});u.on("columnhide",function(v){t._lazySetHidenConfig()});u.on("columnshow",function(v){t._lazySetHidenConfig()})},_initStrethEvent:function(){var t=this,v=f.one("."+j,t.form),u=f.one("."+o,t.form);if(v&&u){v.on("click",function(){u.toggleClass(e);if(u.hasClass(e)){v.addClass(c);v.removeClass(l)}else{v.removeClass(c);v.addClass(l)}var w=t._getLastVisibleLine(),x=t.btn.parent(".form-field-container");if(!x){x=t.btn.parent(".form-actions")}if(w&&x){x.appendTo(w)}if(t.get("gridConfig").autoFit){t.autoFitHeight()}})}},_initDataEvent:function(){var t=this,u=t.store;u.on("exception",function(w){if(w.responseText&&f.indexOf(w.responseText,"DOCTYPE html")>=0){top.location.reload()}else{var v=f.LP.version==2?"2.0":"1.0";f.use(v+"/message",function(x,y){x.LP.Message.Alert(w.error)})}})},_initResizeEvent:function(){var t=this,u=null;function v(){t.autoFitWidth();t.autoFitHeight()}if(t.get("isCrossPage")&&top.pageManger&&t.get("gridConfig").autoFit){u=top.pageManger.getTabId();top.pageManger.tabBindEvent("",u,"tabResize",v);f.Event.on(window,"unload",function(){top.pageManger.tabDetachEvent("",u,"tabResize",v)})}},_getData:function(w){var t=this,v=t.form,u=t.store,x=f.LP.FormHelpr.serializeToObject(v);if(w){x.start=0;x.pageIndex=0}u.load(x);t.fire("reloadGrid",{param:x})},_lazySetHidenConfig:function(){var t=this,u=t.get("func");if(u){u.cancel()}u=f.later(t._setHidenConfig,500,false,t);t.set("func",u)},_setHidenConfig:function(){var t=this,u=[],v=t.get("gridConfig").columns;f.each(v,function(x){if(x.hide===true){var w=x.dataIndex;u.push(w)}});q.setItem(a(),u.join(";"));t.set("func",null)},autoFitWidth:function(){var t=this,u=t.grid,v=d();u.setWidth(v)},autoFitHeight:function(){var u=this,v=u.grid,t=n(u.renderTo);v.setHeight(t)},getData:function(t){this._getData(t)},getParam:function(){var t=this,u=t.form,v=f.LP.FormHelpr.serializeToObject(u);return v}});g.pageSeach=h;g.pageSearch=h;g.getGridCommandTemp=function(t){return['<span class="grid-command ',t.css,'" data-title="',t.title,'" data-id="',t.id,'" data-type="',t.type,'" data-href="',t.href,'" href="',t.href,'" data-module="',t.moduleId,'">',t.text,"</span>"].join("")};g.getOperationTemp=function(w){var v=w.items,t=[],u=null;f.each(v,function(x){t.push("<li>"+g.getGridCommandTemp(x)+"</li>")});u=['<span class="grid-command command-btn">',w.text,'<span class="grid-command-trigger"></span><ul class="ks-hidden">',t.join(""),"</ul></span>"].join("");return u};g.createStore=function(u,t){return new f.LP.Store({url:u,autoLoad:false,dataType:t})};function m(u){var v=q.getItem(a());if(v){var t=v.split(";");f.each(u,function(x){var w=x.dataIndex;if(f.inArray(w,t)){x.hide=true}})}}function a(){var v=location.href,y=v.split("/"),x=y.length,w=y[x-1],u=w.indexOf("."),t=w.substring(0,u);if(x<=2){return t}return y[x-2]+"-"+t}function d(){var u=f.DOM.viewportWidth(),t=40;if(f.UA.ie<=7){t=60}return u-t}function n(w){var t=f.one("#"+w),u=f.DOM.viewportHeight(),v=t.offset();if(u>v.top){return u-v.top-r}return 0}g.createGridConfig=function(x,C,u,A){u=u||{};var G=(u&&u.renderTo)||"grid",v=u?u.autoFit:false,E=null;A=A||50;m(x);var F=0,w=0,z=d(),D=(u&&u.checkable)?31:0,t=1,B=0;f.each(x,function(H){H.width=H.width||80;if(!H.hide){F+=H.width;w+=1}});if(!v){t=(z-2-D-w*2)/F;if(t<=1){z=F}u.forceFit=true}else{E=n(G);t=(z-2-D-w*2-17)/F;if(t>1){f.each(x,function(H){if(!H.hide){H.width=Math.floor(H.width*t);B+=H.width}});z=B+w*2+2+D+17}}var y={renderTo:G,columns:x,store:C,height:E,showMenu:true,bbar:{pageSize:A},loadMask:true,width:z};if(u){f.mix(y,u)}return y}},{requires:["1.0/local-storage"]});
